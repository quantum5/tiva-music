#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>
#include "inc/tm4c123gh6pm.h"
#include "inc/hw_memmap.h"
#include "driverlib/gpio.h"
#include "driverlib/rom.h"
#include "driverlib/sysctl.h"

#include "player.h"

const struct {
	int freq;
	int len;
} song[] = {
		  {659, 175}, {698, 175}, {783, 2100}, {698, 175}, {659, 175}, {587, 175},
		  {523, 175}, {587, 175}, {659, 175}, {587, 700}, {0, 175}, {523, 350},
		  {349, 175}, {349, 1050}, {523, 350}, {440, 175}, {523, 350}, {523, 175},
		  {440, 175}, {523, 525}, {440, 175}, {392, 525}, {440, 175}, {329, 350},
		  {261, 700}, {0, 350}, {659, 175}, {698, 175}, {783, 2100}, {698, 175},
		  {659, 175}, {587, 175}, {523, 175}, {587, 175}, {659, 175}, {587, 700},
		  {0, 175}, {523, 350}, {349, 175}, {349, 1050}, {523, 350}, {440, 175},
		  {523, 350}, {523, 175}, {440, 175}, {523, 525}, {440, 175}, {392, 525},
		  {440, 175}, {329, 350}, {261, 700}, {261, 175}, {261, 175}, {261, 350},
		  {261, 175}, {261, 175}, {261, 350}, {261, 175}, {261, 175}, {261, 350},
		  {261, 175}, {261, 175}, {261, 350}, {261, 175}, {261, 175}, {349, 350},
		  {349, 175}, {349, 175}, {349, 350}, {349, 175}, {349, 175}, {349, 350},
		  {349, 175}, {349, 175}, {349, 700}, {523, 525}, {349, 525}, {261, 175},
		  {261, 175}, {261, 350}, {261, 175}, {261, 175}, {261, 350}, {329, 175},
		  {349, 175}, {392, 1050}, {440, 175}, {392, 350}, {349, 175}, {329, 175},
		  {349, 175}, {329, 175}, {392, 350}, {349, 350}, {261, 350}, {261, 175},
		  {261, 175}, {261, 350}, {261, 175}, {261, 175}, {261, 350}, {261, 175},
		  {261, 175}, {261, 350}, {261, 175}, {261, 175}, {349, 350}, {349, 175},
		  {349, 175}, {349, 350}, {349, 175}, {349, 175}, {349, 350}, {349, 175},
		  {349, 175}, {349, 700}, {523, 525}, {349, 175}, {349, 350}, {261, 175},
		  {261, 175}, {261, 350}, {261, 175}, {261, 175}, {261, 350}, {261, 175},
		  {293, 175}, {329, 350}, {329, 175}, {329, 175}, {329, 350}, {349, 175},
		  {329, 175}, {293, 175}, {329, 175}, {349, 175}, {329, 175}, {392, 350},
		  {349, 350}, {329, 350}, {659, 175}, {698, 175}, {783, 2100}, {698, 175},
		  {659, 175}, {587, 175}, {523, 175}, {587, 175}, {659, 175}, {587, 700},
		  {0, 175}, {523, 350}, {349, 175}, {349, 1050}, {523, 350}, {440, 175},
		  {523, 350}, {523, 175}, {440, 175}, {523, 525}, {440, 175}, {392, 525},
		  {440, 175}, {329, 350}, {261, 1050}, {0, 350}, {659, 175}, {698, 175},
		  {783, 2100}, {698, 175}, {659, 175}, {587, 175}, {523, 175}, {587, 175},
		  {659, 175}, {587, 700}, {0, 175}, {523, 350}, {349, 175}, {349, 1050},
		  {523, 350}, {440, 175}, {523, 350}, {523, 175}, {440, 175}, {523, 525},
		  {440, 175}, {392, 525}, {440, 175}, {329, 350}, {261, 700}, {0, 350},
		  {659, 175}, {698, 175}, {783, 350}, {0, 1400}, {698, 175}, {659, 175},
		  {587, 175}, {523, 175}, {587, 175}, {659, 175}, {587, 350}, {0, 350},
		  {523, 350}, {349, 175}, {349, 350}, {0, 525}, {523, 350}, {440, 175},
		  {523, 350}, {523, 175}, {440, 175}, {523, 525}, {440, 175}, {392, 525},
		  {440, 175}, {329, 350}, {261, 700}, {0, 350}, {659, 175}, {698, 175},
		  {783, 2100}, {698, 175}, {659, 175}, {587, 175}, {523, 175}, {587, 175},
		  {659, 175}, {587, 700}, {523, 350}, {349, 175}, {349, 1050}, {523, 350},
		  {440, 175}, {523, 350}, {523, 175}, {440, 175}, {523, 525}, {440, 175},
		  {392, 525}, {440, 175}, {329, 350}, {261, 700}, {261, 175}, {261, 175},
		  {277, 350}, {277, 175}, {277, 175}, {277, 350}, {277, 175}, {277, 175},
		  {277, 350}, {277, 175}, {277, 175}, {277, 350}, {277, 175}, {277, 175},
		  {369, 350}, {369, 175}, {369, 175}, {369, 350}, {369, 175}, {369, 175},
		  {369, 350}, {369, 175}, {369, 175}, {369, 700}, {554, 525}, {369, 175},
		  {369, 700}, {369, 175}, {369, 175}, {369, 350}, {369, 175}, {369, 175},
		  {369, 350}, {554, 175}, {622, 175}, {698, 1050}, {739, 175}, {698, 350},
		  {622, 350}, {349, 175}, {369, 175}, {349, 175}, {415, 350}, {369, 350},
		  {349, 350}, {349, 175}, {349, 175}, {349, 350}, {523, 175}, {523, 175},
		  {523, 350}, {277, 175}, {277, 175}, {277, 350}, {277, 175}, {277, 175},
		  {277, 350}, {277, 175}, {277, 175}, {369, 350}, {369, 175}, {369, 175},
		  {369, 350}, {369, 175}, {369, 175}, {369, 350}, {369, 175}, {369, 175},
		  {369, 175}, {369, 175}, {369, 175}, {369, 175}, {554, 525}, {369, 175},
		  {369, 350}, {369, 175}, {369, 175}, {369, 350}, {369, 175}, {369, 175},
		  {369, 350}, {277, 175}, {277, 175}, {277, 350}, {554, 175}, {622, 175},
		  {698, 1050}, {739, 175}, {698, 350}, {622, 175}, {698, 175}, {739, 175},
		  {698, 175}, {830, 350}, {739, 350}, {698, 350}, {369, 175}, {392, 175},
		  {369, 525}, {0, 350}, {369, 175}, {329, 175}, {329, 175}, {329, 175},
		  {440, 525}, {329, 350}, {293, 525}, {293, 175}, {293, 350}, {587, 350},
		  {440, 700}, {0, 350}, {392, 350}, {369, 175}, {392, 175}, {369, 525},
		  {0, 350}, {369, 175}, {329, 175}, {329, 175}, {329, 175}, {440, 525},
		  {329, 350}, {293, 525}, {293, 175}, {293, 350}, {587, 350}, {440, 700},
		  {0, 700}, {392, 350}, {369, 175}, {392, 175}, {369, 350}, {392, 175},
		  {369, 175}, {392, 175}, {369, 175}, {392, 175}, {369, 350}, {392, 175},
		  {369, 175}, {392, 175}, {369, 175}, {466, 175}, {554, 175}, {659, 175},
		  {659, 350}, {587, 350}, {493, 350}, {369, 350}, {329, 700}, {293, 350},
		  {329, 350}, {369, 175}, {392, 175}, {369, 700}, {493, 350}, {440, 700},
		  {369, 700}, {329, 525}, {369, 525}, {392, 525}, {261, 525}, {329, 525},
		  {369, 525}, {392, 525}, {0, 525}, {587, 525}, {587, 525}, {587, 525},
		  {587, 525}, {587, 525}, {587, 525}, {587, 2100}, {659, 262}, {698, 262},
		  {783, 1400}, {0, 350}, {698, 175}, {659, 175}, {587, 175}, {523, 175},
		  {587, 175}, {659, 175}, {587, 700}, {0, 175}, {523, 350}, {349, 175},
		  {349, 1050}, {523, 350}, {440, 175}, {523, 350}, {523, 175}, {440, 175},
		  {523, 525}, {440, 175}, {392, 525}, {440, 175}, {329, 350}, {261, 700},
		  {0, 350}, {659, 175}, {698, 175}, {783, 2100}, {698, 175}, {659, 175},
		  {587, 175}, {523, 175}, {587, 175}, {659, 175}, {587, 700}, {523, 350},
		  {349, 175}, {349, 1050}, {523, 350}, {440, 175}, {523, 350}, {523, 175},
		  {440, 175}, {523, 525}, {440, 175}, {392, 525}, {440, 175}, {329, 350},
		  {261, 700}, {0, 700}, {783, 175}, {830, 175}, {932, 2100}, {830, 175},
		  {783, 175}, {698, 175}, {622, 175}, {698, 175}, {783, 175}, {698, 700},
		  {622, 350}, {415, 175}, {415, 1050}, {622, 350}, {523, 175}, {622, 350},
		  {622, 175}, {523, 175}, {622, 525}, {523, 175}, {466, 525}, {523, 175},
		  {392, 350}, {311, 700}, {0, 700}, {783, 175}, {830, 175}, {932, 2100},
		  {830, 175}, {783, 175}, {698, 175}, {622, 175}, {698, 175}, {783, 175},
		  {698, 700}, {622, 350}, {415, 175}, {415, 1050}, {622, 350}, {523, 175},
		  {622, 350}, {622, 175}, {523, 175}, {622, 525}, {523, 175}, {466, 525},
		  {523, 175}, {392, 350}, {311, 700}, {0, 350},
};

void pwm_main(void);

int main(void) {
	printf("System start. Clock rate is %d Hz.\n", SysCtlClockGet());

	// This sets the clock to 40 MHz.
	// Have yet to figure out how to get PWM working on 80 MHz.
	SysCtlClockSet(SYSCTL_SYSDIV_5 | SYSCTL_USE_PLL | SYSCTL_OSC_MAIN | SYSCTL_XTAL_16MHZ);

	uint32_t clock_rate = SysCtlClockGet();
	printf("Updated clock rate to %u Hz.\n", clock_rate);

	// Enable GPIO block F.
    SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOF);
    while (!SysCtlPeripheralReady(SYSCTL_PERIPH_GPIOF));

    //pwm_main();

    // Set PF2 pin to output.
    GPIOPinTypeGPIOOutput(GPIO_PORTF_BASE, GPIO_PIN_2);

    for (int i = 0; i < (sizeof song / sizeof *song); ++i) {
    	printf("Playing %d Hz tone for %d ms\n", song[i].freq, song[i].len);

    	if (!song[i].freq) {
    		ROM_SysCtlDelay(song[i].len * (clock_rate / 3000));
    		continue;
    	}

    	int cycles = clock_rate / song[i].freq / 6;
    	int loops = song[i].len * (clock_rate / 6000) / cycles;

		while (loops --> 0) {
			// Toggle square wave on, wait, off, then wait again.
			GPIO_PORTF_DATA_R |= GPIO_PIN_2;
			ROM_SysCtlDelay(cycles);
			GPIO_PORTF_DATA_R &= ~GPIO_PIN_2;
			ROM_SysCtlDelay(cycles);
		}
    }
}
